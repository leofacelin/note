<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ZINEBONOTE</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ==============================
           ğŸ¨ CSS å˜é‡ï¼šè‰²å½©ç®¡ç†ç³»ç»Ÿ
           ============================== */
        :root {
            --bg-color: #f0f0f0;
            --text-color: #333;
            --header-color: #1a1a1a;
            --timestamp-color: rgba(0, 0, 0, 0.2);
            --shadow-color: rgba(0,0,0,0.05);
            --divider-color: #ddd;
            --fab-bg: rgba(255,255,255,0.9);
            --fab-icon: #333;
            --toggle-btn-color: #999;
            --filter-banner-bg: #333;
            --filter-banner-text: #fff;
            
            /* ğŸ·ï¸ äº®è‰²æ¨¡å¼ä¸‹çš„å¡ç‰‡é¢œè‰² (åŸæ¥çš„é©¬å¡é¾™è‰²) */
            --note-bg-1: rgb(239, 217, 196); /* æè‰² */
            --note-bg-2: rgb(207, 229, 212); /* æµ…ç»¿ */
            --note-bg-3: rgb(253, 214, 209); /* æµ…ç²‰ */
            --note-bg-4: rgb(204, 222, 236); /* æµ…è“ */
            --note-bg-5: rgb(212, 212, 212); /* æµ…ç° */
            --note-bg-6: rgb(230, 230, 250); /* æ·¡ç´« (è¡¥å……ä¸€ä¸ª) */

            /* ğŸ·ï¸ æ ‡ç­¾é¢œè‰² */
            --tag-text-color: #999; 
            --tag-text-hover: #666;
        }

        /* ğŸŒ‘ æ·±è‰²æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                
                /* è°ƒæ•´ï¼šæ–‡å­—ä¸å†æ˜¯çº¯ç™½ï¼Œæ”¹ä¸ºæŸ”å’Œçš„ç°ç™½ï¼Œé™ä½æ˜åº¦ */
                --text-color: #b0b0b0; 
                
                /* è°ƒæ•´ï¼šæ—¥æœŸæ ‡é¢˜é™ä½æ˜åº¦ */
                --header-color: #888888; 
                
                --timestamp-color: rgba(255, 255, 255, 0.3);
                --shadow-color: rgba(0,0,0,0.5);
                --divider-color: #333;
                --fab-bg: rgba(40,40,40,0.9);
                --fab-icon: #ccc; /* æŒ‰é’®å›¾æ ‡ä¹Ÿé™ä½ä¸€ç‚¹æ˜åº¦ */
                --toggle-btn-color: #666;
                --filter-banner-bg: #444;
                --filter-banner-text: #ccc;

                /* ğŸ·ï¸ æ·±è‰²æ¨¡å¼ä¸‹çš„å¡ç‰‡é¢œè‰² (ä¿ç•™è‰²ç›¸ï¼Œå¤§å¹…é™ä½äº®åº¦) */
                --note-bg-1: #3e322a; /* æ·±æè‰² */
                --note-bg-2: #2a352d; /* æ·±ç»¿è‰² */
                --note-bg-3: #3e2a2a; /* æ·±çº¢è‰² */
                --note-bg-4: #2a323a; /* æ·±è“è‰² */
                --note-bg-5: #2a2a2a; /* æ·±ç°è‰² */
                --note-bg-6: #32323e; /* æ·±ç´«è‰² */

                /* æ ‡ç­¾åœ¨æ·±è‰²æ¨¡å¼ä¸‹ä¹Ÿå¯ä»¥ç¨å¾®æš—ä¸€ç‚¹ */
                --tag-text-color: #777; 
                --tag-text-hover: #aaa;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { scrollbar-width: none; -ms-overflow-style: none; }
        ::-webkit-scrollbar { display: none; }

        body {
            background-color: var(--bg-color); 
            font-family: 'Rubik', "Source Han Sans CN", "Noto Sans SC", sans-serif;
            margin: 0;
            padding: 0 10px 40px 10px; 
            color: var(--text-color);
            min-height: 100vh;
            display: flex; flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #top-bar-container {
            max-width: 600px; margin: 0 auto; position: sticky; top: 20px; z-index: 1000;
            display: flex; justify-content: flex-end; pointer-events: none; height: 0; overflow: visible; 
            width: 100%;
        }

        .fab-btn {
            pointer-events: auto; width: 56px; height: 56px;
            background: var(--fab-bg); backdrop-filter: blur(10px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer;
            transition: transform 0.2s, background-color 0.3s; margin-top: 10px; margin-right: 10px; 
        }
        .fab-btn:active { transform: scale(0.9); }
        .fab-btn svg { width: 28px; height: 28px; fill: var(--fab-icon); }

        #btn-export { display: none; margin-right: 10px; background: #4a90e2; }
        #btn-export svg { fill: #fff; }

        #filter-banner {
            display: none; max-width: 600px; margin: 10px auto 0 auto;
            background: var(--filter-banner-bg); color: var(--filter-banner-text);
            padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: 500;
            align-items: center; justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); animation: slideUp 0.3s ease-out;
            cursor: pointer; z-index: 900;
        }
        #filter-banner span { display: flex; align-items: center; }
        #filter-banner .clear-icon { margin-left: 10px; font-size: 16px; opacity: 0.8; }

        #timeline-container { 
            max-width: 600px; margin: 0 auto; padding-top: 20px; width: 100%; flex: 1; 
        }

        .month-divider {
            display: flex; align-items: center; justify-content: center;
            margin: 40px 0 10px 0; opacity: 0.6;
        }
        .month-divider span {
            background: var(--bg-color); padding: 0 15px; font-size: 12px; 
            color: var(--text-color); font-weight: bold; letter-spacing: 1px;
            border: 1px solid var(--divider-color); border-radius: 20px;
        }

        .date-header-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            margin: 30px 0 15px 0;
        }

        .date-header {
            font-family: 'Rubik', sans-serif; font-weight: 700; 
            font-size: 46px;
            color: var(--header-color); letter-spacing: -2px; line-height: 1;
            padding-left: 5px; 
            transition: color 0.3s ease;
        }

        .toggle-btn {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.3s ease, background 0.2s;
            margin-right: 5px;
        }
        .toggle-btn svg { width: 24px; height: 24px; fill: var(--toggle-btn-color); }
        .toggle-btn:active { background: rgba(0,0,0,0.05); }
        .toggle-btn.collapsed { transform: rotate(-90deg); }

        .card-stack { 
            display: flex; flex-direction: column; margin-bottom: 20px; 
            transition: opacity 0.3s ease, max-height 0.3s ease;
            opacity: 1;
        }
        .card-stack.hidden-stack { display: none; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .note-card {
            /* å…³é”®ä¿®æ”¹ï¼šèƒŒæ™¯è‰²ç”±å†…è”æ ·å¼(JS)æ§åˆ¶ï¼Œè¿™é‡Œåªæä¾›åŸºç¡€è¿‡æ¸¡ */
            /* åœ¨æ·±è‰²æ¨¡å¼ä¸‹ï¼Œä¸å†å¼ºåˆ¶è¦†ç›–ä¸ºæ·±ç°è‰²ï¼Œè€Œæ˜¯ä¾èµ–å˜é‡ */
            padding: 24px; position: relative; cursor: pointer; 
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), margin-bottom 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
            border-radius: 24px 24px 0 0; margin-top: -24px; 
            box-shadow: 0 -2px 10px var(--shadow-color); padding-bottom: 40px; 
            animation: slideUp 0.4s ease-out backwards; 
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹ï¼Œç¨å¾®åŠ ä¸€ç‚¹è¾¹æ¡†è®©å¡ç‰‡åœ¨æ·±è‰²èƒŒæ™¯æ›´æ¸…æ™° */
        @media (prefers-color-scheme: dark) {
            .note-card {
                border: 1px solid rgba(255,255,255,0.03);
            }
        }

        .card-stack .note-card:first-child { margin-top: 0; box-shadow: none; }
        .card-stack .note-card:last-child { border-radius: 24px; padding-bottom: 24px; box-shadow: 0 4px 15px var(--shadow-color); }
        .note-card:active { transform: scale(0.99); }
        .note-card.deleting { opacity: 0; transform: translateX(-50px) scale(0.9); margin-bottom: -100px; z-index: -1; }

        .note-content {
            font-size: 20px; 
            font-weight: 400; line-height: 1.6; color: var(--text-color);
            word-break: break-all; white-space: pre-wrap;
        }

        /* ğŸ·ï¸ æ ‡ç­¾æ ·å¼ */
        .tag-link {
            color: var(--tag-text-color);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            margin-right: 2px;
        }
        .tag-link:hover { text-decoration: underline; color: var(--tag-text-hover); }

        .note-timestamp {
            font-size: 11px; text-align: right; margin-top: 10px; color: var(--timestamp-color); 
            font-weight: 500; letter-spacing: 0.5px;
        }

        .note-img {
            display: block; margin-top: 20px; max-height: 200px; border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2); width: 100%; object-fit: cover;
        }

        .btn-delete {
            position: absolute; top: 12px; right: 12px; width: 32px; height: 32px;
            background: rgba(0,0,0,0.1); backdrop-filter: blur(4px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-color); font-size: 18px; font-weight: bold;
            z-index: 10; opacity: 0; transform: scale(0.8); transition: all 0.2s; pointer-events: none; 
        }
        @media (hover: hover) { .note-card:hover .btn-delete { opacity: 1; transform: scale(1); pointer-events: auto; } }
        .note-card.active .btn-delete { opacity: 1; transform: scale(1); pointer-events: auto; }

        #input-wrapper { margin-bottom: 10px; }
        
        /* è¾“å…¥æ¡†å¡ç‰‡ä¹Ÿéœ€è¦è·Ÿéšä¸»é¢˜å˜è‰²ï¼Œè¿™é‡Œé»˜è®¤ç”¨ --note-bg-5 (ç°è‰²) æˆ–é»˜è®¤èƒŒæ™¯ */
        #input-card-container {
            display: none; 
            background: var(--note-bg-5); /* ä½¿ç”¨å˜é‡èƒŒæ™¯ */
            border-radius: 24px; padding: 20px;
            margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-direction: row; height: 180px; 
            animation: slideUp 0.3s ease-out;
        }

        #inputBox {
            flex: 1; border: none; outline: none; background: transparent;
            font-family: inherit; font-size: 22px; 
            resize: none; padding-right: 15px; overflow-y: auto; color: var(--text-color);
        }
        
        .input-actions {
            width: 50px; display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            border-left: 1px solid var(--divider-color); padding-left: 15px;
        }

        .action-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative; 
        }
        .btn-upload { background: rgba(0,0,0,0.05); }
        .btn-save { background: #81c784; color: white; }
        .btn-save.loading { background: #ccc; pointer-events: none; }
        .action-btn svg { width: 22px; height: 22px; }
        .btn-upload svg { fill: var(--text-color); opacity: 0.5; }
        .btn-save svg { fill: #fff; }

        .img-indicator {
            width: 10px; height: 10px; background: #ff4d4f; border: 2px solid #fff; 
            border-radius: 50%; position: absolute; top: -2px; right: -2px; 
            display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #fileInput { display: none; }

        #statusMsg {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; font-size: 14px;
            padding: 10px 20px; border-radius: 30px; z-index: 2000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; font-weight: 500;
        }
        #statusMsg.show { opacity: 1; }

        #modalOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2001; backdrop-filter: blur(2px);
        }
        #confirmModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--note-bg-5); padding: 30px; border-radius: 20px; z-index: 2002;
            text-align: center; width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            color: var(--text-color);
        }
        .modal-btn {
            padding: 12px 25px; border-radius: 12px; border: none; font-size: 16px; margin: 0 5px; font-weight: bold; cursor: pointer;
        }
        .btn-yes { background: #ff4d4f; color: white; }
        .btn-no { background: rgba(0,0,0,0.1); color: var(--text-color); }

        #imageViewerModal {
            display: none; position: fixed; z-index: 3000; top: 0; left: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.95);
            align-items: center; justify-content: center; padding: 20px;
            cursor: zoom-out; animation: fadeIn 0.2s ease-out;
        }
        #expandedImage {
            max-width: 100%; max-height: 100%; object-fit: contain;
            border-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: zoomIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .app-footer {
            text-align: center; font-size: 11px; color: #999; padding: 40px 0 20px 0;
            font-family: 'Rubik', sans-serif; opacity: 0.6; margin-top: auto; 
            cursor: pointer; user-select: none;
        }

    </style>
</head>
<body>

    <div id="top-bar-container">
        <div id="btn-export" class="fab-btn" onclick="exportData()">
            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
        </div>
        <div class="fab-btn" onclick="toggleInput()">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </div>
    </div>
    
    <div id="filter-banner" onclick="clearFilter()">
        <span id="filter-text">Filtering by tag</span>
        <span class="clear-icon">âœ•</span>
    </div>

    <div id="statusMsg">å‡†å¤‡å°±ç»ª</div>

    <div id="timeline-container"></div>

    <div class="app-footer" onclick="triggerGodMode()">ZINEBONOTE Made with ğŸ™‚</div>

    <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect()">

    <div id="modalOverlay" onclick="closeModal()"></div>
    <div id="confirmModal">
        <p style="margin: 0 0 25px; font-size: 20px; font-weight: bold;">ç¡®å®šåˆ é™¤å—ï¼Ÿ</p>
        <button class="modal-btn btn-yes" onclick="confirmDelete()">åˆ é™¤</button>
        <button class="modal-btn btn-no" onclick="closeModal()">å–æ¶ˆ</button>
    </div>

    <div id="imageViewerModal" onclick="closeImageViewer()">
        <img id="expandedImage" src="" alt="Full size image">
    </div>

    <script>
        // ==========================================
        // ğŸ‘‡ é…ç½®åŒº ğŸ‘‡
        // ==========================================
        const BIN_ID = '692adac043b1c97be9cca688'; 
        const API_KEY = '$2a$10$ebskDQwSsOfisis5TCXKdOHQ4LlGGnXpggBygD6/bcWPenwaHVAgi';
        const  IMGBB_KEY = '08cce3fc7e17f608d3d26c37f4dac6be';     
        // ==========================================

        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        
        const REQ_HEADERS = {
            'Content-Type': 'application/json',
            'X-Master-Key': API_KEY 
        };

        let currentData = { notes: [] };
        let pendingDeleteId = null;
        let selectedFile = null;
        let isInputOpen = false;
        let draftText = "";
        let activeTag = null; 
        
        // ğŸ¨ é‡ç‚¹ä¿®æ”¹ï¼šä¸å†ä½¿ç”¨RGBå€¼ï¼Œè€Œæ˜¯ä½¿ç”¨CSSå˜é‡å
        // è¿™æ · JS åªéœ€è¦åˆ†é…å˜é‡åï¼Œå…·ä½“é¢œè‰²ç”± CSS çš„åª’ä½“æŸ¥è¯¢å†³å®š
        const DAY_COLORS = [
            'var(--note-bg-1)', 
            'var(--note-bg-2)', 
            'var(--note-bg-3)', 
            'var(--note-bg-4)', 
            'var(--note-bg-5)', 
            'var(--note-bg-6)'
        ];

        let myUserId = localStorage.getItem('zinebonote_user_id');
        if (!myUserId) {
            const oldKey = localStorage.getItem('mylog_user_id'); 
            if (oldKey) {
                myUserId = oldKey;
                localStorage.setItem('zinebonote_user_id', oldKey); 
            } else {
                myUserId = 'u_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                localStorage.setItem('zinebonote_user_id', myUserId);
            }
        }

        let isGodMode = false;
        let godModeClicks = 0;
        let godModeTimer = null;

        function triggerGodMode() {
            godModeClicks++;
            if (godModeTimer) clearTimeout(godModeTimer);
            godModeTimer = setTimeout(() => { godModeClicks = 0; }, 2000);

            if (godModeClicks >= 5) {
                isGodMode = !isGodMode; 
                godModeClicks = 0;
                updateStatus(isGodMode ? "ğŸ¦¸â€â™‚ï¸ ä¸Šå¸æ¨¡å¼ï¼šå·²å¼€å¯" : "ğŸ”’ ä¸Šå¸æ¨¡å¼ï¼šå·²å…³é—­");
                const exportBtn = document.getElementById('btn-export');
                if (exportBtn) exportBtn.style.display = isGodMode ? 'flex' : 'none';
                renderTimeline();
            }
        }

        function exportData() {
            if (!currentData.notes || currentData.notes.length === 0) {
                updateStatus("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
                return;
            }
            const dataStr = JSON.stringify(currentData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zinebonote_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateStatus("å·²ä¸‹è½½å¤‡ä»½æ–‡ä»¶");
        }

        async function loadData() {
            const localCache = localStorage.getItem('zinebonote_v1_data'); 
            if (localCache) {
                currentData = JSON.parse(localCache);
                renderTimeline();
            }
            try {
                const res = await fetch(API_URL, { method: 'GET', headers: { 'X-Master-Key': API_KEY } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                currentData = json.record;
                localStorage.setItem('zinebonote_v1_data', JSON.stringify(currentData));
                renderTimeline();
            } catch (e) {
                console.error(e);
                if(!localCache) updateStatus('âŒ æ— æ³•è¿æ¥äº‘ç«¯: ' + e.message);
            }
        }

        function getMonthKey(dateObj) {
            return `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}`;
        }

        function filterByTag(tag) {
            activeTag = tag;
            const banner = document.getElementById('filter-banner');
            document.getElementById('filter-text').textContent = `ğŸ” ${tag}`;
            banner.style.display = 'flex';
            renderTimeline();
            if(isInputOpen) toggleInput();
        }

        function clearFilter() {
            activeTag = null;
            document.getElementById('filter-banner').style.display = 'none';
            renderTimeline();
        }

        function formatContent(text) {
            if (!text) return '';
            const safeText = text.replace(/&/g, "&amp;")
                                 .replace(/</g, "&lt;")
                                 .replace(/>/g, "&gt;")
                                 .replace(/"/g, "&quot;")
                                 .replace(/'/g, "&#039;");
            
            return safeText.replace(/(#[\u4e00-\u9fa5\w]+)/g, 
                '<span class="tag-link" onclick="event.stopPropagation(); filterByTag(\'$1\')">$1</span>');
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = ''; 

            let notesToRender = (currentData.notes || []);
            if (activeTag) {
                notesToRender = notesToRender.filter(n => n.text && n.text.includes(activeTag));
            }
            notesToRender = notesToRender.sort((a, b) => b.id - a.id);

            const groups = {};
            
            notesToRender.forEach(note => {
                let d;
                if (note.date && !isNaN(Date.parse(note.date))) {
                    d = new Date(note.date);
                } else {
                    d = new Date(note.id); 
                }
                
                let dateKey = formatDate(d, true);
                if (!groups[dateKey]) groups[dateKey] = { notes: [], dateObj: d };
                groups[dateKey].notes.push(note);
            });

            const sortedKeys = Object.keys(groups).sort((a, b) => {
                const dateA = groups[a].dateObj;
                const dateB = groups[b].dateObj;
                const isAToday = formatDate(new Date(), true) === a;
                const isBToday = formatDate(new Date(), true) === b;
                if(isAToday) return -1;
                if(isBToday) return 1;
                return dateB - dateA;
            });

            const realTodayKey = formatDate(new Date(), true);
            if (!activeTag) {
                if (!groups[realTodayKey]) {
                    sortedKeys.unshift(realTodayKey);
                } else {
                    if(sortedKeys[0] !== realTodayKey) {
                        const idx = sortedKeys.indexOf(realTodayKey);
                        if(idx > -1) sortedKeys.splice(idx, 1);
                        sortedKeys.unshift(realTodayKey);
                    }
                }
            }

            let lastMonthKey = null;

            if (sortedKeys.length === 0 && activeTag) {
                container.innerHTML = `<div style="text-align:center; padding:50px; opacity:0.5;">æœªæ‰¾åˆ°æ ‡ç­¾: ${activeTag}</div>`;
                return;
            }

            sortedKeys.forEach(key => {
                const isToday = (key === realTodayKey);
                const displayTitle = isToday ? "Today" : key;
                
                const groupDateObj = groups[key] ? groups[key].dateObj : new Date();
                const currentMonthKey = getMonthKey(groupDateObj);

                if (lastMonthKey && currentMonthKey !== lastMonthKey) {
                    const monthDivider = document.createElement('div');
                    monthDivider.className = 'month-divider';
                    monthDivider.innerHTML = `<span>${currentMonthKey.replace('-','.')}</span>`;
                    container.appendChild(monthDivider);
                }
                lastMonthKey = currentMonthKey;

                if (!window.sessionColorMap) window.sessionColorMap = {};
                if (!window.sessionColorMap[key]) {
                    window.sessionColorMap[key] = DAY_COLORS[Math.floor(Math.random() * DAY_COLORS.length)];
                }
                
                const headerWrapper = document.createElement('div');
                headerWrapper.className = 'date-header-wrapper';

                const headerText = document.createElement('div');
                headerText.className = 'date-header';
                headerText.textContent = displayTitle;

                headerWrapper.appendChild(headerText);

                const groupNotes = groups[key] ? groups[key].notes : [];

                if (groupNotes.length > 0) {
                    const stackId = 'stack-' + key.replace(/[^a-zA-Z0-9]/g, '-'); 
                    const toggleBtn = document.createElement('div');
                    toggleBtn.className = 'toggle-btn';
                    toggleBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>'; 
                    
                    toggleBtn.onclick = () => {
                        const stack = document.getElementById(stackId);
                        if(stack) {
                            stack.classList.toggle('hidden-stack');
                            toggleBtn.classList.toggle('collapsed');
                        }
                    };
                    headerWrapper.appendChild(toggleBtn);
                }

                container.appendChild(headerWrapper);

                if (isToday && !activeTag) {
                    const inputContainer = document.createElement('div');
                    inputContainer.id = 'input-wrapper'; 
                    container.appendChild(inputContainer);
                    if (isInputOpen) renderInputCard(inputContainer);
                }

                if (groupNotes.length > 0) {
                    const stackContainer = document.createElement('div');
                    stackContainer.className = 'card-stack';
                    stackContainer.id = 'stack-' + key.replace(/[^a-zA-Z0-9]/g, '-'); 
                    
                    let lastColor = null;

                    groupNotes.forEach((note, index) => {
                        const card = document.createElement('div');
                        card.className = 'note-card';
                        card.id = 'note-' + note.id; 
                        
                        let availableColors = DAY_COLORS;
                        if (lastColor) availableColors = DAY_COLORS.filter(c => c !== lastColor);
                        const randomColor = availableColors[Math.floor(Math.random() * availableColors.length)];
                        
                        // ğŸ¨ ç›´æ¥èµ‹å€¼å˜é‡åï¼Œç”± CSS è§£æé¢œè‰²
                        card.style.backgroundColor = randomColor;
                        lastColor = randomColor; 

                        card.style.zIndex = index + 1;
                        card.style.animationDelay = `${index * 0.05}s`; 
                        
                        card.onclick = (e) => toggleActive(card, e);

                        const canDelete = (!note.creatorId) || (note.creatorId === myUserId) || isGodMode;
                        
                        if (canDelete) {
                            const delBtn = document.createElement('div');
                            delBtn.className = 'btn-delete';
                            delBtn.textContent = 'Ã—';
                            delBtn.onclick = (e) => { e.stopPropagation(); showDeleteModal(note.id); }
                            card.appendChild(delBtn);
                        }

                        const content = document.createElement('div');
                        content.className = 'note-content';
                        content.innerHTML = formatContent(note.text);
                        card.appendChild(content);

                        if (note.img) {
                            const img = document.createElement('img');
                            img.className = 'note-img';
                            img.src = note.img; 
                            img.onclick = (e) => { e.stopPropagation(); openImageViewer(note.img); }
                            card.appendChild(img);
                        }

                        let timeStr = "";
                        try {
                            if(note.date && note.date.includes(' ')) {
                                timeStr = note.date.split(' ')[1].substring(0, 5); 
                            } else {
                                const d = new Date(note.id);
                                timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                            }
                        } catch(e) {}

                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'note-timestamp';
                        timeDiv.textContent = timeStr;
                        card.appendChild(timeDiv);
                        
                        stackContainer.appendChild(card);
                    });
                    container.appendChild(stackContainer);
                }
            });
        }

        function renderInputCard(wrapper) {
            wrapper.innerHTML = `
                <div id="input-card-container" style="display: flex;">
                    <textarea id="inputBox" placeholder="è®°å½•æ­¤åˆ»...ä½¿ç”¨ #æ ‡ç­¾ åˆ†ç±»" oninput="draftText = this.value">${draftText}</textarea>
                    <div class="input-actions">
                        <div class="action-btn btn-upload" onclick="document.getElementById('fileInput').click()">
                            <div style="position:relative;">
                                <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                <div id="img-dot" class="img-indicator"></div>
                            </div>
                        </div>
                        <div id="btnSave" class="action-btn btn-save" onclick="addNote()">
                            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            `;
            if(selectedFile) document.getElementById('img-dot').style.display = 'block';
            setTimeout(() => { const box = document.getElementById('inputBox'); if(box) box.focus(); }, 100);
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('img-dot').style.display = 'block';
                document.getElementById('inputBox').focus();
            }
        }

        async function addNote() {
            const btnSave = document.getElementById('btnSave');
            try {
                const box = document.getElementById('inputBox');
                if(box) draftText = box.value;
                const text = draftText.trim();
                const fileToUpload = selectedFile;

                if (!text && !fileToUpload) { updateStatus('å†™ç‚¹ä»€ä¹ˆå§'); return; }

                if(btnSave) { btnSave.classList.add('loading'); btnSave.style.opacity = '0.5'; }

                const tempId = Date.now();
                let displayImgUrl = null;
                if (fileToUpload) displayImgUrl = URL.createObjectURL(fileToUpload);

                const now = new Date();
                const fullTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

                const newNote = {
                    id: tempId, text: text, img: displayImgUrl, date: fullTime, creatorId: myUserId 
                };

                if (!currentData.notes) currentData.notes = [];
                currentData.notes.push(newNote);

                selectedFile = null; draftText = ""; isInputOpen = false;
                document.getElementById('fileInput').value = '';
                
                if(activeTag) clearFilter();
                else renderTimeline(); 

                if (fileToUpload) {
                    updateStatus('æ­£åœ¨åŒæ­¥å›¾ç‰‡...');
                    const realUrl = await uploadImage(fileToUpload);
                    if (realUrl) {
                        const targetNote = currentData.notes.find(n => n.id === tempId);
                        if (targetNote) { targetNote.img = realUrl; await saveData(); }
                    } else {
                        updateStatus('å›¾ç‰‡å¤±è´¥ï¼Œå·²å­˜æ–‡å­—');
                        alert('âš ï¸ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œä½†æ–‡å­—å·²ä¿å­˜ã€‚');
                        const targetNote = currentData.notes.find(n => n.id === tempId);
                        if(targetNote) targetNote.img = null; 
                        renderTimeline(); await saveData(); 
                    }
                } else {
                    updateStatus('æ­£åœ¨ä¿å­˜...');
                    await saveData(); 
                }
            } catch (err) { alert("ç¨‹åºå‡ºé”™: " + err.message); } 
            finally { if(btnSave) { btnSave.classList.remove('loading'); btnSave.style.opacity = '1'; } }
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: formData });
                const data = await res.json();
                return data.success ? data.data.url : null;
            } catch (e) { return null; }
        }

        async function saveData() {
            try {
                const res = await fetch(API_URL, { method: 'PUT', headers: REQ_HEADERS, body: JSON.stringify(currentData) });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                localStorage.setItem('zinebonote_v1_data', JSON.stringify(currentData));
                updateStatus('å·²åŒæ­¥ âœ…');
            } catch (e) { alert(`âš ï¸ ä¿å­˜å¤±è´¥ï¼š${e.message}`); updateStatus('ä¿å­˜å¤±è´¥'); }
        }

        function toggleInput() { 
            isInputOpen = !isInputOpen; 
            
            const wrapper = document.getElementById('input-wrapper');
            if (!wrapper) {
                if (activeTag) clearFilter(); 
                else renderTimeline();
                return;
            }

            if (isInputOpen) {
                renderInputCard(wrapper);
            } else {
                const card = document.getElementById('input-card-container');
                if (card) card.remove();
            }
        }

        function toggleActive(card, e) {
            if (e.target.classList.contains('tag-link')) return;

            if (e.target.closest('#input-card-container')) return;
            const wasActive = card.classList.contains('active');
            document.querySelectorAll('.note-card.active').forEach(c => c.classList.remove('active'));
            if (!wasActive) card.classList.add('active');
        }
        document.addEventListener('click', function(e) { 
            if (!e.target.closest('.note-card') && !e.target.closest('.app-footer') && !e.target.closest('#top-bar-container') && !e.target.closest('.toggle-btn') && !e.target.closest('#filter-banner')) {
                document.querySelectorAll('.note-card.active').forEach(c => c.classList.remove('active')); 
            }
        });

        function showDeleteModal(id) {
            pendingDeleteId = id;
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('confirmModal').style.display = 'block';
        }
        async function confirmDelete() {
            if (!pendingDeleteId) return;
            const idToDelete = pendingDeleteId;
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
            const cardEl = document.getElementById('note-' + idToDelete);
            if (cardEl) { cardEl.classList.add('deleting'); await new Promise(resolve => setTimeout(resolve, 300)); }
            const idx = currentData.notes.findIndex(n => n.id === idToDelete);
            if (idx > -1) { currentData.notes.splice(idx, 1); renderTimeline(); saveData(); }
            pendingDeleteId = null;
        }
        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
            pendingDeleteId = null;
        }

        let statusTimeout = null;
        function updateStatus(msg) {
            const el = document.getElementById('statusMsg'); el.textContent = msg; el.classList.add('show');
            if(statusTimeout) clearTimeout(statusTimeout);
            statusTimeout = setTimeout(() => el.classList.remove('show'), 2000);
        }

        function formatDate(dateObj, forComparison = false) {
            const now = new Date();
            const isSameDay = (dateObj.getDate() === now.getDate() && dateObj.getMonth() === now.getMonth() && dateObj.getFullYear() === now.getFullYear());
            if (isSameDay && !forComparison) return "Today"; 
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${monthNames[dateObj.getMonth()]}.${dateObj.getDate()}`;
        }

        function openImageViewer(src) { document.getElementById('expandedImage').src = src; document.getElementById('imageViewerModal').style.display = 'flex'; }
        function closeImageViewer() { document.getElementById('imageViewerModal').style.display = 'none'; document.getElementById('expandedImage').src = ''; }

        loadData();
    </script>
</body>
</html>
