<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æˆ‘çš„æ—¶å…‰æ—¥å¿—</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { scrollbar-width: none; -ms-overflow-style: none; }
        ::-webkit-scrollbar { display: none; }

        body {
            background-color: #dcc6b0; 
            font-family: 'Roboto', "Source Han Sans CN", "Noto Sans SC", sans-serif;
            margin: 0;
            /* 1. æ›´æ–°ï¼šå·¦å³ padding ä» 20px å‡å°åˆ° 10pxï¼Œå¡ç‰‡æ›´å®½ */
            padding: 0 10px 80px 10px; 
            color: #333;
            min-height: 100vh;
        }

        #top-bar-container {
            max-width: 600px; margin: 0 auto; position: sticky; top: 20px; z-index: 1000;
            display: flex; justify-content: flex-end; pointer-events: none; height: 0; overflow: visible; 
        }

        .fab-add {
            pointer-events: auto; width: 56px; height: 56px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer;
            transition: transform 0.2s; margin-top: 10px; margin-right: 10px; /* è¡¥å¿ä¸€ç‚¹å³è¾¹è· */
        }
        .fab-add:active { transform: scale(0.9); }
        .fab-add svg { width: 32px; height: 32px; fill: #333; }

        #timeline-container { max-width: 600px; margin: 0 auto; padding-top: 20px; }

        .date-header {
            font-family: 'Roboto', sans-serif; font-weight: 900; font-size: 51px;
            color: #1a1a1a; margin: 40px 0 20px 0; letter-spacing: -2px; line-height: 1;
            padding-left: 5px; /* æ ‡é¢˜ç¨å¾®ç¼©è¿›ä¸€ç‚¹ç‚¹å¯¹é½è§†è§‰ */
        }

        .note-card {
            background-color: #fff; border-radius: 24px; padding: 24px;
            margin-bottom: 20px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; cursor: pointer; 
            
            /* 2. æ›´æ–°ï¼šå¢åŠ é€æ˜åº¦å’Œå˜æ¢çš„è¿‡æ¸¡ï¼Œä¸ºåˆ é™¤åŠ¨ç”»åšå‡†å¤‡ */
            transition: all 0.3s ease-out;
            opacity: 1;
            transform: scale(1);
        }
        .note-card:active { transform: scale(0.99); }

        /* 2. æ›´æ–°ï¼šåˆ é™¤æ—¶çš„åŠ¨ç”»çŠ¶æ€ç±» */
        .note-card.deleting {
            opacity: 0;
            transform: scale(0.9);
            margin-bottom: -100px; /* è¿™æ˜¯ä¸€ä¸ªå°æŠ€å·§ï¼Œè®©åé¢çš„å…ƒç´ æ»‘ä¸Šæ¥ */
        }

        .note-content {
            font-size: 23px; font-weight: 500; line-height: 1.5; color: #222;
            word-break: break-all; white-space: pre-wrap;
        }

        .note-img {
            display: block; margin-top: 20px; max-height: 150px; border-radius: 12px;
            border: 4px solid rgba(255,255,255,0.6);
        }

        .btn-delete {
            position: absolute; top: -12px; right: -12px; width: 36px; height: 36px;
            background: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #ff4d4f; font-size: 18px; font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; opacity: 0;
            transform: scale(0.8); transition: all 0.2s; pointer-events: none; 
        }

        @media (hover: hover) {
            .note-card:hover .btn-delete { opacity: 1; transform: scale(1); pointer-events: auto; }
        }
        .note-card.active .btn-delete { opacity: 1; transform: scale(1); pointer-events: auto; }

        #input-card-container {
            display: none; background: #fff; border-radius: 24px; padding: 20px;
            margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-direction: row; height: 180px; 
        }

        #inputBox {
            flex: 1; border: none; outline: none; background: transparent;
            font-family: inherit; font-size: 22px; resize: none;
            padding-right: 15px; overflow-y: auto; color: #333;
        }
        
        .input-actions {
            width: 50px; display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            border-left: 1px solid #eee; padding-left: 15px;
        }

        .action-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative; 
        }
        .btn-upload { background: #f5f5f5; }
        .btn-save { background: #81c784; color: white; }
        .btn-save.loading { background: #ccc; pointer-events: none; }
        .action-btn svg { width: 22px; height: 22px; }
        .btn-upload svg { fill: #666; }
        .btn-save svg { fill: #fff; }

        .img-indicator {
            width: 10px; height: 10px; background: #ff4d4f; border: 2px solid #fff; 
            border-radius: 50%; position: absolute; top: -2px; right: -2px; 
            display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #fileInput { display: none; }

        #statusMsg {
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; font-size: 14px;
            padding: 10px 20px; border-radius: 30px; z-index: 2000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; font-weight: 500;
        }
        #statusMsg.show { opacity: 1; }

        #modalOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 2001; backdrop-filter: blur(2px);
        }
        #confirmModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; padding: 30px; border-radius: 20px; z-index: 2002;
            text-align: center; width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-btn {
            padding: 12px 25px; border-radius: 12px; border: none; font-size: 16px; margin: 0 5px; font-weight: bold; cursor: pointer;
        }
        .btn-yes { background: #ff4d4f; color: white; }
        .btn-no { background: #f0f0f0; color: #333; }

        #imageViewerModal {
            display: none; position: fixed; z-index: 3000; top: 0; left: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.9);
            align-items: center; justify-content: center; padding: 20px;
            cursor: zoom-out; animation: fadeIn 0.2s ease-out;
        }
        #expandedImage {
            max-width: 100%; max-height: 100%; object-fit: contain;
            border-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            animation: zoomIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <div id="top-bar-container">
        <div class="fab-add" onclick="toggleInput()">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </div>
    </div>

    <div id="statusMsg">å‡†å¤‡å°±ç»ª</div>

    <div id="timeline-container"></div>

    <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect()">

    <div id="modalOverlay" onclick="closeModal()"></div>
    <div id="confirmModal">
        <p style="margin: 0 0 25px; font-size: 20px; font-weight: bold;">ç¡®å®šåˆ é™¤å—ï¼Ÿ</p>
        <button class="modal-btn btn-yes" onclick="confirmDelete()">åˆ é™¤</button>
        <button class="modal-btn btn-no" onclick="closeModal()">å–æ¶ˆ</button>
    </div>

    <div id="imageViewerModal" onclick="closeImageViewer()">
        <img id="expandedImage" src="" alt="Full size image">
    </div>

    <script>
        // ==========================================
        // ğŸ‘‡ é…ç½®åŒº ğŸ‘‡
        // ==========================================
        const BIN_ID = '692adac043b1c97be9cca688'; 
        const API_KEY = '$2a$10$ebskDQwSsOfisis5TCXKdOHQ4LlGGnXpggBygD6/bcWPenwaHVAgi';
        const  IMGBB_KEY = '08cce3fc7e17f608d3d26c37f4dac6be';  
        // ==========================================

        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        
        const REQ_HEADERS = {
            'Content-Type': 'application/json',
            'X-Master-Key': API_KEY 
        };

        let currentData = { notes: [] };
        let pendingDeleteId = null;
        let selectedFile = null;
        let isInputOpen = false;
        let draftText = "";
        
        const DAY_COLORS = ['#ebdccb', '#cce3d4', '#f4d0d2', '#e1f5fe', '#fff9c4', '#e1bee7'];
        let sessionColorMap = {};

        async function loadData() {
            const localCache = localStorage.getItem('mylog_fix_final'); 
            if (localCache) {
                currentData = JSON.parse(localCache);
                renderTimeline();
            }
            try {
                const res = await fetch(API_URL, { method: 'GET', headers: { 'X-Master-Key': API_KEY } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                currentData = json.record;
                localStorage.setItem('mylog_fix_final', JSON.stringify(currentData));
                renderTimeline();
            } catch (e) {
                console.error(e);
                if(!localCache) updateStatus('âŒ æ— æ³•è¿æ¥äº‘ç«¯: ' + e.message);
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸å†ç®€å•åœ° innerHTML = '' æ¸…ç©º
            // å› ä¸ºå¦‚æœæ˜¯åˆ é™¤æ“ä½œå¼•å‘çš„é‡ç»˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¤„ç†åŠ¨ç”»
            // ä½†ä¸ºäº†ä»£ç ç®€å•ï¼Œæˆ‘ä»¬åªåœ¨æ·»åŠ /åˆå§‹åŒ–æ—¶å…¨é‡æ¸²æŸ“
            // åˆ é™¤æ“ä½œæˆ‘ä»¬ä¼šå•ç‹¬åœ¨ DOM ä¸Šæ“ä½œï¼Œä¸èµ°è¿™é‡Œ
            
            container.innerHTML = ''; 

            const notes = (currentData.notes || []).sort((a, b) => b.id - a.id);
            const groups = {};
            const realTodayKey = formatDate(new Date(), true);

            notes.forEach(note => {
                const d = note.date ? new Date(note.date) : new Date(note.id);
                const dateKey = formatDate(d, true);
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(note);
            });

            let sortedKeys = [];
            if (notes.length > 0) {
                 const keySet = new Set();
                 keySet.add(realTodayKey);
                 notes.forEach(n => keySet.add(formatDate(n.date?new Date(n.date):new Date(n.id), true)));
                 sortedKeys = Array.from(keySet);
            } else {
                sortedKeys = [realTodayKey];
            }

            sortedKeys.forEach(key => {
                const isToday = (key === realTodayKey);
                const displayTitle = isToday ? "Today" : key;

                if (!sessionColorMap[key]) {
                    sessionColorMap[key] = DAY_COLORS[Math.floor(Math.random() * DAY_COLORS.length)];
                }
                const groupColor = sessionColorMap[key];

                const header = document.createElement('div');
                header.className = 'date-header';
                header.textContent = displayTitle;
                container.appendChild(header);

                if (isToday) {
                    const inputContainer = document.createElement('div');
                    inputContainer.id = 'input-wrapper'; 
                    container.appendChild(inputContainer);
                    if (isInputOpen) renderInputCard(inputContainer);
                }

                const groupNotes = groups[key] || [];
                groupNotes.forEach(note => {
                    const card = document.createElement('div');
                    card.className = 'note-card';
                    card.id = 'note-' + note.id; // ç»™æ¯ä¸ªå¡ç‰‡åŠ  IDï¼Œæ–¹ä¾¿åˆ é™¤æ—¶æ‰¾
                    card.style.backgroundColor = groupColor;
                    card.onclick = (e) => toggleActive(card, e);

                    const delBtn = document.createElement('div');
                    delBtn.className = 'btn-delete';
                    delBtn.textContent = 'Ã—';
                    delBtn.onclick = (e) => {
                        e.stopPropagation(); 
                        showDeleteModal(note.id);
                    }
                    card.appendChild(delBtn);

                    const content = document.createElement('div');
                    content.className = 'note-content';
                    content.textContent = note.text || '';
                    card.appendChild(content);

                    if (note.img) {
                        const img = document.createElement('img');
                        img.className = 'note-img';
                        img.src = note.img; 
                        img.onclick = (e) => {
                            e.stopPropagation();
                            openImageViewer(note.img);
                        }
                        card.appendChild(img);
                    }
                    container.appendChild(card);
                });
            });
        }

        function renderInputCard(wrapper) {
            wrapper.innerHTML = `
                <div id="input-card-container" style="display: flex;">
                    <textarea id="inputBox" placeholder="è®°å½•æ­¤åˆ»..." oninput="draftText = this.value">${draftText}</textarea>
                    
                    <div class="input-actions">
                        <div class="action-btn btn-upload" onclick="document.getElementById('fileInput').click()">
                            <div style="position:relative;">
                                <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                                <div id="img-dot" class="img-indicator"></div>
                            </div>
                        </div>
                        <div id="btnSave" class="action-btn btn-save" onclick="addNote()">
                            <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                        </div>
                    </div>
                </div>
            `;
            if(selectedFile) {
                const dot = document.getElementById('img-dot');
                if(dot) dot.style.display = 'block';
            }
            setTimeout(() => {
                const box = document.getElementById('inputBox');
                if(box) {
                    box.focus();
                    box.setSelectionRange(box.value.length, box.value.length);
                }
            }, 100);
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                selectedFile = file;
                const dot = document.getElementById('img-dot');
                if(dot) dot.style.display = 'block';
                const box = document.getElementById('inputBox');
                if(box) box.focus();
            }
        }

        async function addNote() {
            const btnSave = document.getElementById('btnSave');
            try {
                const box = document.getElementById('inputBox');
                if(box) draftText = box.value;
                const text = draftText.trim();
                const fileToUpload = selectedFile;

                if (!text && !fileToUpload) { updateStatus('å†™ç‚¹ä»€ä¹ˆå§'); return; }

                if(btnSave) {
                    btnSave.classList.add('loading');
                    btnSave.style.opacity = '0.5';
                }

                const tempId = Date.now();
                let displayImgUrl = null;

                if (fileToUpload) displayImgUrl = URL.createObjectURL(fileToUpload);

                const now = new Date();
                const fullTime = now.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

                const newNote = {
                    id: tempId, text: text, img: displayImgUrl, date: fullTime
                };

                if (!currentData.notes) currentData.notes = [];
                currentData.notes.push(newNote);

                selectedFile = null; draftText = ""; isInputOpen = false;
                document.getElementById('fileInput').value = '';
                
                renderTimeline(); 

                if (fileToUpload) {
                    updateStatus('æ­£åœ¨åŒæ­¥å›¾ç‰‡...');
                    const realUrl = await uploadImage(fileToUpload);
                    if (realUrl) {
                        const targetNote = currentData.notes.find(n => n.id === tempId);
                        if (targetNote) { targetNote.img = realUrl; await saveData(); }
                    } else {
                        updateStatus('å›¾ç‰‡å¤±è´¥ï¼Œå·²å­˜æ–‡å­—');
                        alert('âš ï¸ å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼ˆKeyå¤±æ•ˆæˆ–ç½‘ç»œé—®é¢˜ï¼‰ï¼Œä½†æ–‡å­—å·²ä¿å­˜ã€‚');
                        const targetNote = currentData.notes.find(n => n.id === tempId);
                        if(targetNote) targetNote.img = null; 
                        renderTimeline(); await saveData(); 
                    }
                } else {
                    updateStatus('æ­£åœ¨ä¿å­˜...');
                    await saveData(); 
                }
            } catch (err) {
                alert("ç¨‹åºå‡ºé”™: " + err.message);
            } finally {
                if(btnSave) { btnSave.classList.remove('loading'); btnSave.style.opacity = '1'; }
            }
        }

        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                    method: 'POST', body: formData
                });
                const data = await res.json();
                return data.success ? data.data.url : null;
            } catch (e) {
                return null;
            }
        }

        async function saveData() {
            try {
                const res = await fetch(API_URL, {
                    method: 'PUT', headers: REQ_HEADERS, body: JSON.stringify(currentData)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                localStorage.setItem('mylog_fix_final', JSON.stringify(currentData));
                updateStatus('å·²åŒæ­¥ âœ…');
            } catch (e) {
                alert(`âš ï¸ ä¿å­˜å¤±è´¥ï¼š${e.message}\nè¯·æ£€æŸ¥ Keyã€‚`);
                updateStatus('ä¿å­˜å¤±è´¥');
            }
        }

        function toggleInput() {
            isInputOpen = !isInputOpen;
            renderTimeline();
        }

        function toggleActive(card, e) {
            if (e.target.closest('#input-card-container')) return;
            const wasActive = card.classList.contains('active');
            document.querySelectorAll('.note-card.active').forEach(c => c.classList.remove('active'));
            if (!wasActive) card.classList.add('active');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.note-card')) {
                document.querySelectorAll('.note-card.active').forEach(c => c.classList.remove('active'));
            }
        });

        function showDeleteModal(id) {
            pendingDeleteId = id;
            closeModal(); // å…³æ‰ä¹‹å‰çš„ï¼ˆå¦‚æœæœ‰ï¼‰
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('confirmModal').style.display = 'block';
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šå¸¦åŠ¨ç”»çš„åˆ é™¤é€»è¾‘ ---
        async function confirmDelete() {
            if (!pendingDeleteId) return;
            
            // 1. å…³æ‰å¼¹çª—
            closeModal();

            // 2. æ‰¾åˆ° DOM å…ƒç´ 
            const cardEl = document.getElementById('note-' + pendingDeleteId);
            if (cardEl) {
                // 3. æ·»åŠ  .deleting ç±»ï¼Œè§¦å‘ CSS åŠ¨ç”» (300ms)
                cardEl.classList.add('deleting');
                
                // 4. ç­‰å¾…åŠ¨ç”»ç»“æŸ (300ms)
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            // 5. çœŸæ­£åˆ é™¤æ•°æ®
            const idx = currentData.notes.findIndex(n => n.id === pendingDeleteId);
            if (idx > -1) {
                currentData.notes.splice(idx, 1);
                // è¿™é‡Œé‡æ–°æ¸²æŸ“ä¼šç§»é™¤è¯¥å…ƒç´ 
                renderTimeline(); 
                saveData(); 
            }
            pendingDeleteId = null;
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('confirmModal').style.display = 'none';
        }

        let statusTimeout = null;
        function updateStatus(msg) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.classList.add('show');
            if(statusTimeout) clearTimeout(statusTimeout);
            statusTimeout = setTimeout(() => el.classList.remove('show'), 2000);
        }

        function formatDate(dateObj, forComparison = false) {
            const now = new Date();
            const isSameDay = (dateObj.getDate() === now.getDate() && 
                               dateObj.getMonth() === now.getMonth() && 
                               dateObj.getFullYear() === now.getFullYear());
            if (isSameDay && !forComparison) return "Today"; 
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${monthNames[dateObj.getMonth()]}.${dateObj.getDate()}`;
        }

        function openImageViewer(src) {
            const modal = document.getElementById('imageViewerModal');
            const img = document.getElementById('expandedImage');
            img.src = src;
            modal.style.display = 'flex';
        }

        function closeImageViewer() {
            const modal = document.getElementById('imageViewerModal');
            modal.style.display = 'none';
            document.getElementById('expandedImage').src = '';
        }

        loadData();
    </script>
</body>
</html>
